<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bean Machine Order Calculator</title>
  <style>
    :root {
      --brown:#6b4f3b; --tan:#d7c3a3; --cream:#f7f3ec; --ink:#1f1a17; --muted:#6a6a6a;
      --border:#e7e1d6; --shadow:0 10px 30px rgba(0,0,0,.08);
      --bg:#faf8f3; --panel:#fff; --card:#fff; --chip:#f5efe6; --text:var(--ink); --accent:var(--brown); --radius:16px;
      --bg-dark:#14110f; --panel-dark:#1d1916; --card-dark:#231e1a; --chip-dark:#2c2621; --text-dark:#efe9e2; --border-dark:#3b322b;
    }
    [data-theme="dark"]{ --bg:var(--bg-dark); --panel:var(--panel-dark); --card:var(--card-dark); --chip:var(--chip-dark); --text:var(--text-dark); --border:var(--border-dark); }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans",Arial}
    h1,h2,h3,h4{font-family:Georgia,"Times New Roman",serif;letter-spacing:.2px}
    .container{max-width:1200px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:48px;height:48px;border-radius:12px;box-shadow:var(--shadow);position:relative;background:linear-gradient(135deg,var(--tan) 0 50%,var(--brown) 50% 100%)}
    .brand .logo::after{content:"‚òï";position:absolute;inset:0;display:grid;place-items:center;font-size:22px}
    .brand h1{margin:0;font-size:1.4rem;letter-spacing:.3px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius)}
    .panel h2{margin:0;padding:16px 18px;font-size:1rem;border-bottom:1px solid var(--border)}
    .panel .content{padding:16px}
    .section{margin-bottom:16px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .card h3{margin:0;font-size:1rem}
    .price{color:var(--accent);font-weight:700}
    .muted{color:var(--muted);font-size:.9rem}
    .qty{display:grid;grid-template-columns:32px 1fr 32px;align-items:center;gap:8px;margin-top:6px}
    .qty button{height:36px;border-radius:10px;border:1px solid var(--border);background:var(--chip);color:var(--text);cursor:pointer;font-size:18px}
    .qty output{text-align:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--chip);color:var(--text);cursor:pointer;font-weight:600;text-decoration:none}
    .btn.primary{background:linear-gradient(135deg,var(--brown),var(--tan));border:none;color:#fff}
    .btn.block{width:100%}
    .btn.ghost{background:transparent}
    .toolrow{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted);font-weight:700;font-size:.85rem}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .summary{display:flex;flex-direction:column;gap:14px}
    .summary .row{display:flex;justify-content:space-between;align-items:center}
    .summary .row.total{font-size:1.2rem;font-weight:800}
    .discount{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .discount input[type="range"]{width:100%}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:transparent;border:2px solid #8b5e3c;color:#8b5e3c;border-radius:8px;padding:4px 8px;font-weight:800}
    .order-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:6px}
    .cart-item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:8px;border-bottom:1px dashed var(--border)}
    .cart-item:last-child{border-bottom:none}
    .small{font-size:.85rem;color:var(--muted)}
    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .tabs .btn[aria-selected="true"]{outline:2px solid var(--accent)}
    dialog{width:min(760px,92vw);background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:18px;padding:0}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border)}
    .modal-body{padding:16px;display:grid;gap:18px}
    .option{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--card)}
    .selector-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .select-card{border:1px solid var(--border);background:var(--card);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .select-title{font-weight:700}
    .select-qty{display:grid;grid-template-columns:32px 1fr 32px;align-items:center;gap:8px}
    .select-qty button{height:32px;border-radius:8px;border:1px solid var(--border);background:var(--chip)}
    .ing-list{display:grid;grid-template-columns:1fr auto;gap:8px}
    .ing-actions{display:flex;gap:8px;justify-content:flex-end}
    .punchtray{display:flex;gap:8px;flex-wrap:wrap}
    .chipbox{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;background:var(--chip);border:1px dashed #cab8a0}
    .chipbox.filled{background:repeating-conic-gradient(from 0deg,var(--brown) 0 20%,#593d2e 0 40%);border:none;color:#fff}
    .chipbox.free{border:1px solid var(--brown)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Bean Machine Order Calculator</h1>
          <div class="muted">Pick drinks & bakes, add deals, apply discounts, and get an exact total.</div>
        </div>
      </div>
      <div class="toolrow">
        <span class="chip">Autosaves</span>
        <button class="btn ghost" id="themeBtn" aria-pressed="false" title="Toggle dark mode">üåô Dark</button>
        <button class="btn ghost" id="resetBtn">Clear All</button>
        <button class="btn primary" id="checkoutBtn">Checkout</button>
      </div>
    </header>

    <div class="flagbar" aria-hidden="true" style="height:10px;border-radius:8px;overflow:hidden;margin-bottom:18px;">
      <div style="display:flex;height:100%;">
        <div style="flex:1;background:var(--tan)"></div>
        <div style="flex:1;background:var(--cream)"></div>
        <div style="flex:1;background:var(--brown)"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Menu -->
      <section class="panel">
        <h2>Menu</h2>
        <div class="content">
          <div class="section">
            <h3 style="margin:0 0 8px 0">Coffee & Cocoa</h3>
            <div class="cards" id="classic"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Meal Bundles</h3>
            <div class="cards" id="mealBundles"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Specials</h3>
            <div class="cards" id="specials"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Bean Box</h3>
            <div class="cards" id="beanBox"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Bakes, Ice Cream & Drinks</h3>
            <div class="cards" id="extras"></div>
          </div>
        </div>
      </section>

      <!-- Right: Orders -->
      <aside class="panel">
        <h2>Orders</h2>
        <div class="content">
          <div class="tabs" role="tablist" aria-label="Order panels">
            <button class="btn" data-tab="summary" aria-selected="true">üßæ Summary</button>
            <button class="btn" data-tab="history" aria-selected="false">üìú History</button>
            <button class="btn" data-tab="ingredients" aria-selected="false">üß∫ Ingredients</button>
            <button class="btn" data-tab="loyalty" aria-selected="false">‚≠ê Loyalty</button>
          </div>

          <!-- SUMMARY TAB -->
          <div id="tab-summary" role="tabpanel">
            <div class="option" style="margin-bottom:10px;">
              <div>
                <div><strong>Fulfillment</strong></div>
                <div class="small">City $50 ¬∑ Sandy $100 ¬∑ Paleto $150</div>
              </div>
              <div style="display:flex; gap:10px; align-items:center;">
                <label><input type="radio" name="fulfill" value="pickup"> Pickup</label>
                <label><input type="radio" name="fulfill" value="delivery"> Delivery</label>
                <select id="zoneSelect" style="margin-left:6px;">
                  <option value="city">City</option>
                  <option value="sandy">Sandy</option>
                  <option value="paleto">Paleto</option>
                </select>
              </div>
            </div>

            <div id="cart" class="order-card">
              <div class="cart-item muted">Your order is empty. Add a drink or bake to get started.</div>
            </div>

            <div class="divider"></div>

            <div class="discount">
              <label for="discountRange">Discount</label>
              <div><span id="discountLabel" class="kbd">0%</span></div>
              <input id="discountRange" type="range" min="0" max="100" step="5" value="0" />
            </div>

            <div class="summary" style="margin-top:12px;">
              <div class="row"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
              <div class="row" id="deliveryRow" style="display:none;"><span>Delivery Fee</span><strong id="deliveryFee">$0.00</strong></div>
              <div class="row"><span>Discount</span><strong id="discount">-$0.00</strong></div>
              <div class="row"><span>Promotions</span><strong id="promotions">-$0.00</strong></div>
              <div class="row total"><span>Total</span><strong id="total">$0.00</strong></div>
              <div class="small" id="promoNotes"></div>
            </div>

            <div class="right-actions" style="margin-top:12px;">
              <button class="btn primary block" id="checkoutBtn2">Checkout</button>
              <button class="btn ghost block" id="resetBtn2">Clear All</button>
            </div>
          </div>

          <!-- HISTORY TAB -->
          <div id="tab-history" role="tabpanel" hidden>
            <div class="summary" style="gap:8px; margin-bottom:8px;">
              <div class="row"><span>Orders served today</span><strong id="ordersToday">0</strong></div>
              <div class="row"><span>Orders served overall</span><strong id="ordersOverall">0</strong></div>
            </div>
            <div id="historyList" class="summary" style="gap:12px;"></div>
            <div class="right-actions" style="margin-top:12px;">
              <button class="btn ghost" id="clearHistoryBtn">Clear History</button>
            </div>
          </div>

          <!-- INGREDIENTS TAB -->
          <div id="tab-ingredients" role="tabpanel" hidden>
            <div class="small muted" style="margin-bottom:6px;">Auto-aggregated from your current cart using each item's recipe and bundle selections.</div>
            <div id="ingredientList" class="order-card" style="padding:12px;">
              <div class="muted">No ingredients yet. Add items to the cart.</div>
            </div>
            <div class="ing-actions" style="margin-top:10px;">
              <button class="btn" id="copyIngBtn">Copy List</button>
              <button class="btn" id="exportIngBtn">Export CSV</button>
            </div>
          </div>

          <!-- LOYALTY TAB -->
          <div id="tab-loyalty" role="tabpanel" hidden>
            <div class="option" style="margin-bottom:10px;">
              <div>
                <div><strong>Loyalty Manager Bean Machine</strong></div>
                <div class="small">10 punches ‚Üí Reward: Large Meal (10 drinks + 10 waffles) + 2 Cheesecakes.</div>
                <div class="small" id="dpStatus">Double Punch Tuesday: auto on Tuesdays</div>
              </div>
              <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:8px;align-items:end;max-width:860px">
                <div>
                  <label class="small muted">Customer Name</label>
                  <input id="loy-player" placeholder="John Doe" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;color:#000" />
                </div>
                <button class="btn primary" id="loy-add">Add Punch</button>
                <div style="text-align:right">
                  <div class="small muted">Visit</div>
                  <div class="toolrow" style="justify-content:flex-end">
                    <span class="chip" id="visitInfo">#1 ‚Ä¢ 0 punched</span>
                    <button class="btn" id="newVisitBtn" title="Start a new visit (resets per-visit limits)">New Visit</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="order-card" style="padding:12px;margin-bottom:10px;">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
                <div>
                  <div class="small muted">Punch Card</div>
                  <div id="loy-tray" class="punchtray" aria-live="polite"></div>
                </div>
                <div class="toolrow">
                  <button class="btn" id="loy-undo">-1 Punch</button>
                  <button class="btn" id="loy-redeem">Redeem Reward ‚Üí Pick Drinks</button>
                </div>
              </div>
              <div id="loy-status" class="small muted" style="margin-top:6px;">‚Äî</div>
            </div>

            <div class="order-card" style="padding:0;">
              <div style="padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;">
                <strong>Customers</strong>
                <div class="small muted" id="loy-stats">Players: 0 ‚Ä¢ Rewards banked: 0</div>
              </div>
              <div style="padding:12px;">
                <table style="width:100%;border-collapse:collapse">
                  <thead>
                    <tr><th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Name</th>
                        <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Punches</th>
                        <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Rewards</th>
                        <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Last</th>
                        <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)"></th></tr>
                  </thead>
                  <tbody id="loy-body"></tbody>
                </table>
              </div>
              <div style="padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn" id="loy-export">Export JSON</button>
                <button class="btn ghost" id="loy-import">Import JSON</button>
              </div>
            </div>
          </div>
          <!-- /LOYALTY TAB -->
        </div>
      </aside>
    </div>
  </div>

  <!-- Combo/Bundle Selector Modal -->
  <dialog id="comboModal">
    <div class="modal-header">
      <strong id="comboTitle">Choose Items</strong>
      <button class="btn" id="closeCombo" aria-label="Close">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="comboSteps"></div>
      <div id="comboContent"></div>
      <div class="toolrow" style="justify-content:flex-end; margin-top:6px;">
        <button class="btn" id="comboPrev" style="display:none;">Back</button>
        <button class="btn primary" id="comboNext">Next</button>
      </div>
    </div>
  </dialog>

  <script>
    // ---------- Config ----------
    const MW_SECOND_OFF = 0.20;           // Mon‚ÄìWed: 20 percent off second Medium
    const WEEKEND_FREEBIES_PER_LARGE = 5; // Thu‚ÄìSat freebies per Large meal

    // ---------- Data ----------
    const MENU = {
      classic: [
        { id:'bev-bean', name:'‚òï Bean Coffee',   price:40,  type:'drink' },
        { id:'bev-capp', name:'‚òï Cappuccino',    price:30,  type:'drink' },
        { id:'bev-esp',  name:'‚ö° Espresso',      price:60,  type:'drink' },
        { id:'bev-iced', name:'üßä Iced Latte',    price:30,  type:'drink' },
        { id:'bev-choc', name:'üç´ Hot Chocolate', price:85, type:'drink' },
      ],
      bundles: [
        { id:'bd-med',   name:'ü•ê Medium Caf√© Meal: 5 Drinks + 5 Waffles',  price:375, type:'bundle', drinksIncluded:5,
          description:'Pick any 5 drinks (ü•§ Pink Lemonade, Bean Coffee, Espresso, Hot Chocolate, Iced Latte). Espresso +$20 each ¬∑ Hot Chocolate +$24 each. Includes 5 Wonder Waffles.' },
        { id:'bd-large', name:'ü•ê Large Caf√© Meal: 10 Drinks + 10 Waffles', price:750, type:'bundle', drinksIncluded:10,
          description:'Pick any 10 drinks (ü•§ Pink Lemonade, Bean Coffee, Espresso, Hot Chocolate, Iced Latte). Espresso +$20 each ¬∑ Hot Chocolate +$24 each. Includes 10 Wonder Waffles.' },

        // Bean Box & Refill
        { id:'pk-beanbox',
          name:'üç± Bean Box: Large Meal + Lunch Box',
          price:980, type:'bundle', drinksIncluded:10,
          description:'Includes 1 Lunch Box + 10 drinks + 10 waffles. Pick from ü•§ Pink Lemonade, Bean Coffee, Espresso, Hot Chocolate, Iced Latte. Espresso +$20 each ¬∑ Hot Chocolate +$24 each.' },
        { id:'rf-beanbox',
          name:'üç± Bean Box Refill: 10 Drinks + 10 Waffles',
          price:540, type:'bundle', drinksIncluded:10,
          description:'10 drinks + 10 waffles. Pick from ü•§ Pink Lemonade, Bean Coffee, Espresso, Hot Chocolate, Iced Latte. Espresso +$20 each ¬∑ Hot Chocolate +$24 each.' },

        { id:'sp-hay',   name:'Hayward Special', price:1250, type:'bundle',
          description:'10 Wonder Waffles + 10 Iced Lattes + 2 Cakes of your choice.' },
        { id:'sp-kids',  name:'Kids Meal', price:2200, type:'bundle',
          description:'5 Wonder Waffles + 5 Hot Chocolates + 1 Kinder Egg.' },
      ],
      extras: [
        { id:'ex-lemon',  name:'ü•§ Pink Lemonade', price:50,  type:'extra', isDrink:true },

        /* ---------- NEW: Ice Creams ---------- */
        { id:'ex-ice-van',  name:'üç¶ Vanilla Ice Cream',       price:20, type:'extra' },
        { id:'ex-ice-choc', name:'üç¶ Chocolate Ice Cream',     price:20, type:'extra' },
        { id:'ex-ice-apple',name:'üç¶ Apple Ice Cream',         price:20, type:'extra' },
        { id:'ex-ice-banana',name:'üç¶ Banana Ice Cream',       price:20, type:'extra' },
        { id:'ex-ice-mango', name:'üç¶ Mango Ice Cream',        price:20, type:'extra' },
        { id:'ex-ice-pom',   name:'üç¶ Pomegranate Ice Cream',  price:20, type:'extra' },
        { id:'ex-ice-water', name:'üç¶ Watermelon Ice Cream',   price:20, type:'extra' },
        { id:'ex-ice-lemon', name:'üç¶ Lemon Ice Cream',        price:20, type:'extra' },
        /* ------------------------------------ */

        { id:'ex-cup',    name:'üßÅ Cupcake',        price:30,  type:'extra' },
        { id:'ex-cookie', name:'üç™ Cream Cookie',   price:40,  type:'extra' },
        { id:'ex-donut',  name:'üç© Donut',          price:25,  type:'extra' },
        { id:'ex-waffle', name:'üßá Wonder Waffle',  price:25,  type:'extra' },

        { id:'ex-cake-berry', name:'üçì Berry Cake',      price:120, type:'extra', isCake:true },
        { id:'ex-cake-lemon', name:'üçã Lemon Cake',      price:120, type:'extra', isCake:true },
        { id:'ex-cake-choc',  name:'üç´ Chocolate Cake',  price:120, type:'extra', isCake:true },

        { id:'ex-cheese', name:'üç∞ Cheesecake',     price:30,  type:'extra' },
        { id:'ex-kinder', name:'ü•ö Kinder Egg',     price:1500, type:'extra' },
        { id:'ex-lunch',  name:'üç± Lunch Box',      price:440,  type:'extra' },
      ],
      specialty:[], deals:[], packs:[],
    };

    // Recipes
    const RECIPE_MAP = {
      'bev-bean': {'Water':2,'Coffee bag':1},
      'bev-iced': {'Coffee bag':1,'Sugar':1,'Milk':1,'Water':1},
      'bev-esp' : {'Coffee bag':2,'Water':2},
      'bev-choc': {'Milk':2,'Sugar':2,'Cocoa Powder':4},

      /* ---------- NEW: Ice Cream recipes ----------
         Base: Ice Cream Cone + Milk
         Chocolate: + Cocoa Powder
         Fruit flavors: + the fruit
      ------------------------------------------------ */
      'ex-ice-van'  : {'Ice Cream Cone':1,'Milk':1},
      'ex-ice-choc' : {'Ice Cream Cone':1,'Milk':1,'Cocoa Powder':1},
      'ex-ice-apple': {'Ice Cream Cone':1,'Milk':1,'Apple':1},
      'ex-ice-banana':{'Ice Cream Cone':1,'Milk':1,'Banana':1},
      'ex-ice-mango': {'Ice Cream Cone':1,'Milk':1,'Mango':1},
      'ex-ice-pom'  : {'Ice Cream Cone':1,'Milk':1,'Pomegranate':1},
      'ex-ice-water': {'Ice Cream Cone':1,'Milk':1,'Watermelon':1},
      'ex-ice-lemon': {'Ice Cream Cone':1,'Milk':1,'Lemon':1},
      /* ------------------------------------------- */

      'ex-cake-berry': {'Flour':1,'Sugar':1,'Milk':1,'Egg':1,'Cherry':1,'Strawberry':1},
      'ex-cake-lemon': {'Flour':1,'Sugar':1,'Milk':1,'Egg':1,'Lemon':2},
      'ex-cake-choc' : {'Flour':1,'Sugar':1,'Milk':1,'Egg':1,'Cocoa Powder':2},
    };

    const currency = n => `$${n.toFixed(2)}`;

    // ---------- State ----------
    const STATE_KEY = 'beanmachine_state_v6';
    const HIST_KEY  = 'beanmachine_history_v6';

    const state = { cart:[], discountPct:0, history:[], fulfillment:'pickup', deliveryZone:'city' };

    try{
      const saved = JSON.parse(localStorage.getItem(STATE_KEY)||'{}');
      const savedHist = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
      if(Array.isArray(savedHist)) state.history = savedHist;
      if(saved){
        if(Array.isArray(saved.cart)) state.cart = saved.cart;
        if(typeof saved.discountPct==='number') state.discountPct = saved.discountPct;
        if(saved.fulfillment) state.fulfillment = saved.fulfillment;
        if(saved.deliveryZone) state.deliveryZone = saved.deliveryZone;
      }
    }catch{}

    const persist = () => localStorage.setItem(STATE_KEY, JSON.stringify(state));
    const persistHistory = () => localStorage.setItem(HIST_KEY, JSON.stringify(state.history));

    // ---------- Helpers ----------
    function findMenuItem(id){
      const pools = [MENU.classic,MENU.specialty,MENU.deals,MENU.packs,MENU.bundles,MENU.extras];
      for(const pool of pools){ const f = pool.find(x=>x.id===id); if(f) return f; }
      return null;
    }
    function getMealDrinkPool(){
      return [
        ...MENU.classic.filter(x=>['bev-bean','bev-esp','bev-iced','bev-choc'].includes(x.id)),
        ...MENU.extras.filter(x=>x.id==='ex-lemon')
      ];
    }

    function getCakePool(){ return MENU.extras.filter(x=>x.id.startsWith('ex-cake-')); }

    // ---------- Cards ----------
    function cardHTML(item){
      const needsCombo = (item.drinksIncluded||0)>0 || item.id==='sp-hay';
      return `
        <article class="card">
          <h3>${item.name}</h3>
          <div class="toolrow" style="justify-content:space-between;">
            <span class="price">${currency(item.price)}</span>
            <div class="qty">
              <button aria-label="decrease">‚àí</button>
              <output>1</output>
              <button aria-label="increase">+</button>
            </div>
          </div>
          ${needsCombo?`<button class="btn" data-wizard="${item.id}">Choose &amp; Add</button>`:`<button class="btn" data-add="${item.id}">Add</button>`}
        </article>`;
    }

    function renderCards(){
      const classic = document.getElementById('classic');
      const mealBundles = document.getElementById('mealBundles');
      const specials = document.getElementById('specials');
      const beanBox = document.getElementById('beanBox');
      const extras  = document.getElementById('extras');

      const make = arr => arr.map(cardHTML).join('');
      classic.innerHTML = make(MENU.classic);
      mealBundles.innerHTML = make(MENU.bundles.filter(i=>['bd-med','bd-large','sp-kids'].includes(i.id)));
      specials.innerHTML = make(MENU.bundles.filter(i=>i.id==='sp-hay'));
      beanBox.innerHTML = make(MENU.bundles.filter(i=>['pk-beanbox','rf-beanbox'].includes(i.id)));
      extras.innerHTML  = make(MENU.extras);

      const allItems = [...MENU.classic,...MENU.bundles,...MENU.extras];

      document.querySelectorAll('.cards .card').forEach(card=>{
        let count=1;
        const out=card.querySelector('output');
        card.querySelector('button[aria-label="decrease"]')?.addEventListener('click',()=>{count=Math.max(1,count-1);out.value=count;});
        card.querySelector('button[aria-label="increase"]')?.addEventListener('click',()=>{count++;out.value=count;});

        const wizId = card.querySelector('[data-wizard]')?.getAttribute('data-wizard');
        if(wizId){
          const item = allItems.find(i=>i.id===wizId);
          card.querySelector('[data-wizard]').addEventListener('click',()=>openComboWizard(item,count));
          return;
        }

        const addId = card.querySelector('[data-add]')?.getAttribute('data-add');
        if(addId){
          const item = allItems.find(i=>i.id===addId);
          card.querySelector('[data-add]').addEventListener('click',()=>{
            addToCart({ id:item.id, name:item.name, unitPrice:item.price, qty:count, type:item.type });
            if(item.id==='sp-kids'){
              addToCart({ id:'ex-waffle', name:'üßá Wonder Waffle (Kids)', unitPrice:0, qty:5*count, type:'extra', meta:'Kids Meal' });
              addToCart({ id:'bev-choc', name:'üç´ Hot Chocolate (Kids)', unitPrice:0, qty:5*count, type:'drink', meta:'Kids Meal' });
              addToCart({ id:'ex-kinder', name:'ü•ö Kinder Egg (Kids)', unitPrice:0, qty:1*count, type:'extra', meta:'Kids Meal' });
            }
          });
        }
      });
    }

    // ---------- Cart ----------
    function renderCart(){
      const cart = document.getElementById('cart');
      if(!state.cart.length){
        cart.innerHTML = `<div class="cart-item muted">Your order is empty. Add a drink or bake to get started.</div>`;
        return;
      }
      cart.innerHTML = state.cart.map((l,idx)=>`
        <div class="cart-item">
          <div>
            <div><strong>${l.name}</strong></div>
            <div class="small">${currency(l.unitPrice)} each${l.meta?` ‚Ä¢ ${l.meta}`:''}</div>
          </div>
          <div class="qty">
            <button data-dec="${idx}">‚àí</button>
            <output>${l.qty}</output>
            <button data-inc="${idx}">+</button>
          </div>
          <div><strong>${currency(l.unitPrice*l.qty)}</strong></div>
        </div>
      `).join('');

      cart.querySelectorAll('[data-inc]').forEach(b=>b.addEventListener('click',()=>{
        const i=+b.getAttribute('data-inc'); state.cart[i].qty++; persist(); renderCart(); renderTotals(); renderIngredients();
      }));
      cart.querySelectorAll('[data-dec]').forEach(b=>b.addEventListener('click',()=>{
        const i=+b.getAttribute('data-dec'); state.cart[i].qty--; if(state.cart[i].qty<=0) state.cart.splice(i,1); persist(); renderCart(); renderTotals(); renderIngredients();
      }));
    }

    function addToCart(line){
      const key = `${line.id||line.name}|${line.unitPrice}|${line.type||''}|${(line.meta||'')}`;
      const found = state.cart.find(l =>
        `${l.id||l.name}|${l.unitPrice}|${l.type||''}|${(l.meta||'')}`===key &&
        JSON.stringify(l.drinks||{})===JSON.stringify(line.drinks||{}) &&
        JSON.stringify(l.cakes||{})===JSON.stringify(line.cakes||{})
      );
      if(found) found.qty += line.qty; else state.cart.push(line);
      persist(); renderCart(); renderTotals(); renderIngredients();
    }

    // ---------- Fulfillment ----------
    const ZONE_FEES = { city:50, sandy:100, paleto:150 };
    function renderFulfillment(){
      document.querySelectorAll('input[name="fulfill"]').forEach(r=> r.checked = (r.value===state.fulfillment));
      const zoneSel=document.getElementById('zoneSelect'); zoneSel.value=state.deliveryZone; zoneSel.disabled = state.fulfillment!=='delivery';
    }
    document.querySelectorAll('input[name="fulfill"]').forEach(r=>{
      r.addEventListener('change', e=>{ state.fulfillment=e.target.value; persist(); renderFulfillment(); renderTotals(); });
    });
    document.getElementById('zoneSelect').addEventListener('change', e=>{ state.deliveryZone=e.target.value; persist(); renderTotals(); });

    // ---------- Promotions ----------
    function computePromotions(){
      const day = new Date().getDay(); // 0 Sun .. 6 Sat
      let notes=[]; let discount=0;

      // Mon‚ÄìWed: Medium second gets 20% off
      if(day>=1 && day<=3){
        const med = state.cart.find(l=>l.id==='bd-med');
        if(med && med.qty>=2){
          const pairs = Math.floor(med.qty/2);
          const off = med.unitPrice * MW_SECOND_OFF * pairs;
          if(off>0){ discount += off; notes.push(`Mon‚ÄìWed: ${pairs} Medium Meal ${MW_SECOND_OFF*100}% off second`); }
        }
      }

      // Thu‚ÄìSat: freebies per Large-equivalent (Large, Bean Box, Refill)
      if(day>=4 && day<=6){
        const largeEqQty = state.cart.reduce((s,l)=>
          s + (['bd-large','pk-beanbox','rf-beanbox'].includes(l.id) ? l.qty : 0), 0);
        if(largeEqQty>0){
          let freebies = WEEKEND_FREEBIES_PER_LARGE * largeEqQty;
          const cup = state.cart.find(l=>l.id==='ex-cup');
          const cookie = state.cart.find(l=>l.id==='ex-cookie');
          if(cup){
            const take = Math.min(freebies, cup.qty);
            discount += take * cup.unitPrice; freebies -= take;
          }
          if(freebies>0 && cookie){
            const take = Math.min(freebies, cookie.qty);
            discount += take * cookie.unitPrice; freebies -= take;
          }
          notes.push(`Thu‚ÄìSat: ${WEEKEND_FREEBIES_PER_LARGE} free cupcake/cookie per Large (incl. Bean Box/Refill)`);
        }
      }

      return { discount:+discount.toFixed(2), notes };
    }

    // ---------- Totals ----------
    function renderTotals(){
      const subtotal = state.cart.reduce((s,l)=>s + l.unitPrice*l.qty, 0);
      const manual = +(subtotal * (state.discountPct/100)).toFixed(2);
      const promo = computePromotions();
      const deliveryFee = state.fulfillment==='delivery' ? (ZONE_FEES[state.deliveryZone]||0) : 0;
      const total = subtotal + deliveryFee - manual - promo.discount;

      document.getElementById('subtotal').textContent = currency(subtotal);
      document.getElementById('discount').textContent = `-${currency(manual)}`;
      document.getElementById('promotions').textContent = `-${currency(promo.discount)}`;
      document.getElementById('total').textContent = currency(total);
      document.getElementById('promoNotes').textContent = promo.notes.join(' ‚Ä¢ ');
      const row = document.getElementById('deliveryRow');
      if(deliveryFee>0){ row.style.display='flex'; document.getElementById('deliveryFee').textContent = currency(deliveryFee); }
      else { row.style.display='none'; document.getElementById('deliveryFee').textContent = currency(0); }
    }

    // ---------- Discount slider ----------
    const range=document.getElementById('discountRange'); const discountLabel=document.getElementById('discountLabel');
    function renderDiscount(){ range.value=state.discountPct; discountLabel.textContent = `${state.discountPct}%`; }
    range.addEventListener('input',()=>{ state.discountPct=+range.value; persist(); renderTotals(); discountLabel.textContent = `${state.discountPct}%`; });

    // ---------- History ----------
    function ordersServedCounters(){
      const todayStr=new Date().toDateString();
      const today=state.history.filter(h=> new Date(h.id).toDateString()===todayStr).length;
      const overall=state.history.length;
      document.getElementById('ordersToday').textContent=today;
      document.getElementById('ordersOverall').textContent=overall;
    }
    function renderHistory(){
      ordersServedCounters();
      const list=document.getElementById('historyList');
      if(!state.history.length){ list.innerHTML='<div class="muted">No past orders yet. Checkout to save one.</div>'; return; }
      list.innerHTML = state.history.map(h=>`
        <article class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <div><strong>${new Date(h.id).toLocaleString()}</strong></div>
              <div class="small">${h.items.length} item(s) ‚Ä¢ Discount ${h.discountPct}%</div>
            </div>
            <div><strong>${currency(h.total)}</strong></div>
          </div>
          <details class="small" style="margin-top:6px;">
            <summary>View items</summary>
            <ul style="margin:6px 0 0 16px;">
              ${h.items.map(i=>`<li>${i.qty}√ó ${i.name}${i.meta?` <span class=small>(${i.meta})</span>`:''} ‚Äî ${currency(i.lineTotal)}</li>`).join('')}
            </ul>
          </details>
          <div class="toolrow" style="justify-content:flex-end;">
            <button class="btn" data-reorder="${h.id}">Reorder</button>
            <button class="btn ghost" data-delete="${h.id}">Delete</button>
          </div>
        </article>
      `).join('');
      list.querySelectorAll('[data-reorder]').forEach(btn=>btn.addEventListener('click',()=>{
        const id=+btn.getAttribute('data-reorder');
        const h=state.history.find(x=>x.id===id); if(!h) return;
        h.items.forEach(it => addToCart({ id:it.id||null, name:it.name, unitPrice:it.unit, qty:it.qty, meta:it.meta||null, drinks:it.drinks||null, cakes:it.cakes||null, type:it.type||'extra' }));
      }));
      list.querySelectorAll('[data-delete]').forEach(btn=>btn.addEventListener('click',()=>{
        const id=+btn.getAttribute('data-delete');
        state.history = state.history.filter(x=>x.id!==id); persistHistory(); renderHistory();
      }));
    }
    document.getElementById('clearHistoryBtn').addEventListener('click',()=>{ if(confirm('Clear all saved orders?')){ state.history=[]; persistHistory(); renderHistory(); ordersServedCounters(); } });

    // ---------- Tabs ----------
    const tabButtons=document.querySelectorAll('[data-tab]');
    function selectTab(which){
      document.getElementById('tab-summary').hidden = which!=='summary';
      document.getElementById('tab-history').hidden = which!=='history';
      document.getElementById('tab-ingredients').hidden = which!=='ingredients';
      document.getElementById('tab-loyalty').hidden = which!=='loyalty';
      tabButtons.forEach(b=>b.setAttribute('aria-selected', String(b.getAttribute('data-tab')===which)));
      if(which==='ingredients') renderIngredients();
      if(which==='history') ordersServedCounters();
      if(which==='loyalty') loyaltyRenderAll();
    }
    tabButtons.forEach(b=>b.addEventListener('click',()=>selectTab(b.getAttribute('data-tab'))));

    // ---------- Wizard (meals, Bean Box & Hayward cakes) ----------
    const comboModal=document.getElementById('comboModal');
    const comboTitle=document.getElementById('comboTitle');
    const comboSteps=document.getElementById('comboSteps');
    const comboContent=document.getElementById('comboContent');
    const comboPrev=document.getElementById('comboPrev');
    const comboNext=document.getElementById('comboNext');
    document.getElementById('closeCombo').addEventListener('click',()=>comboModal.close());

function openComboWizard(item, qty){
  // Helper
  const usedTotal = (counts) => Object.values(counts).reduce((a,b)=>a+b,0);

  // ---------- HAYWARD SPECIAL: choose 2 cakes per bundle ----------
  if(item.id==='sp-hay'){
    const cakesNeeded = 2*(qty||1);
    const cakePool = getCakePool();
    const cakeCounts = {};
    let confirmMode=false;

    const renderCakeGrid=()=>{
      const used = usedTotal(cakeCounts);
      const remaining = cakesNeeded - used;
      comboTitle.textContent = `Cakes: pick ${cakesNeeded} (remaining ${Math.max(0,remaining)})`;
      comboSteps.innerHTML = confirmMode ? '1. Cakes ¬∑ <strong>2. Confirm</strong>' : '<strong>1. Cakes</strong> ¬∑ 2. Confirm';
      comboContent.innerHTML = `
        <div class="selector-grid">
          ${cakePool.map(p=>`
            <div class="select-card" data-id="${p.id}">
              <div class="select-title">${p.name}</div>
              <div class="select-qty">
                <button data-minus="${p.id}">‚àí</button>
                <output data-out="${p.id}">${cakeCounts[p.id]||0}</output>
                <button data-plus="${p.id}">+</button>
              </div>
              <div class="toolrow" style="gap:6px; margin-top:6px;">
                <button class="btn" data-half="${p.id}">Half</button>
                <button class="btn" data-max="${p.id}">Max</button>
              </div>
            </div>`).join('')}
        </div>`;

      // + / ‚àí
      comboContent.querySelectorAll('[data-plus]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id = btn.getAttribute('data-plus');
          if (usedTotal(cakeCounts) < cakesNeeded){
            cakeCounts[id] = (cakeCounts[id]||0) + 1;
            renderCakeGrid();
          }
        });
      });
      comboContent.querySelectorAll('[data-minus]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id = btn.getAttribute('data-minus');
          cakeCounts[id] = Math.max(0, (cakeCounts[id]||0) - 1);
          renderCakeGrid();
        });
      });

      // Half / Max
      comboContent.querySelectorAll('[data-half]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id = btn.getAttribute('data-half');
          const current = cakeCounts[id]||0;
          const usedWithout = usedTotal(cakeCounts) - current;
          const remainingForThis = Math.max(0, cakesNeeded - usedWithout);
          const target = Math.min(Math.ceil(cakesNeeded/2), remainingForThis);
          cakeCounts[id] = target;
          renderCakeGrid();
        });
      });
      comboContent.querySelectorAll('[data-max]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id = btn.getAttribute('data-max');
          const current = cakeCounts[id]||0;
          const usedWithout = usedTotal(cakeCounts) - current;
          const remainingForThis = Math.max(0, cakesNeeded - usedWithout);
          cakeCounts[id] = remainingForThis;
          renderCakeGrid();
        });
      });

      comboPrev.style.display='none';
      comboNext.textContent = confirmMode ? 'Add to Cart' : 'Next';
      comboNext.disabled = remaining>0;
    };

    const renderConfirm=()=>{
      comboTitle.textContent = item.name;
      const fmt = id => (findMenuItem(id)||{}).name||id;
      const list = Object.entries(cakeCounts).filter(([,c])=>c>0).map(([id,c])=>`${fmt(id)} x${c}`);
      comboSteps.innerHTML = '1. Cakes ¬∑ <strong>2. Confirm</strong>';
      comboContent.innerHTML = `
        <div class="summary" style="gap:10px;">
          ${list.length?`<div><strong>Cakes:</strong> ${list.join(', ')}</div>`:''}
          <div class="small muted">Includes 10 Iced Lattes & 10 Waffles automatically.</div>
        </div>`;
      comboPrev.style.display='none';
      comboNext.textContent='Add to Cart';
      comboNext.disabled=false;
    };

    comboPrev.onclick=()=>{};
    comboNext.onclick=()=>{
      if(!confirmMode){ confirmMode=true; renderConfirm(); return; }
      addToCart({ id:item.id, name:item.name, unitPrice:item.price, qty:qty||1, type:item.type, cakes:cakeCounts, meta:'Includes 10 Iced Lattes + 10 Waffles' });
      addToCart({ id:'ex-waffle', name:'üßá Wonder Waffle (Hayward)', unitPrice:0, qty:10*(qty||1), type:'extra', meta:'Hayward Special' });
      addToCart({ id:'bev-iced', name:'üßä Iced Latte (Hayward)', unitPrice:0, qty:10*(qty||1), type:'drink', meta:'Hayward Special' });
      Object.entries(cakeCounts).forEach(([id,c])=>{ if(c>0){
        const nm=(getCakePool().find(x=>x.id===id)||{}).name||'Cake';
        addToCart({ id, name:`${nm} (Hayward)`, unitPrice:0, qty:c, type:'extra', meta:'Hayward Special' });
      }});
      comboModal.close();
    };

    renderCakeGrid();
    comboModal.showModal();
    return;
  }

  // ---------- MEALS & BEAN BOX: choose drinks ----------
  const drinksNeeded = item.drinksIncluded || 0;
  const pool = getMealDrinkPool();
  const counts = {};
  let confirmMode=false;

  const renderGrid=()=>{
    const used = usedTotal(counts);
    const remaining = drinksNeeded - used;
    comboTitle.textContent = `Drinks: pick ${drinksNeeded} (remaining ${Math.max(0,remaining)})`;
    comboSteps.innerHTML = confirmMode ? '1. Drinks ¬∑ <strong>2. Confirm</strong>' : '<strong>1. Drinks</strong> ¬∑ 2. Confirm';
    comboContent.innerHTML = `
      <div class="selector-grid">
        ${pool.map(p=>`
          <div class="select-card" data-id="${p.id}">
            <div class="select-title">${p.name}</div>
            <div class="select-qty">
              <button data-minus="${p.id}">‚àí</button>
              <output data-out="${p.id}">${counts[p.id]||0}</output>
              <button data-plus="${p.id}">+</button>
            </div>
            <div class="toolrow" style="gap:6px; margin-top:6px;">
              <button class="btn" data-half="${p.id}">Half</button>
              <button class="btn" data-max="${p.id}">Max</button>
            </div>
          </div>`).join('')}
      </div>`;

    // + / ‚àí
    comboContent.querySelectorAll('[data-plus]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-plus');
        if (usedTotal(counts) < drinksNeeded){
          counts[id] = (counts[id]||0) + 1;
          renderGrid();
        }
      });
    });
    comboContent.querySelectorAll('[data-minus]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-minus');
        counts[id] = Math.max(0, (counts[id]||0) - 1);
        renderGrid();
      });
    });

    // Half / Max
    comboContent.querySelectorAll('[data-half]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-half');
        const current = counts[id]||0;
        const usedWithout = usedTotal(counts) - current;
        const remainingForThis = Math.max(0, drinksNeeded - usedWithout);
        const target = Math.min(Math.ceil(drinksNeeded/2), remainingForThis);
        counts[id] = target;
        renderGrid();
      });
    });
    comboContent.querySelectorAll('[data-max]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-max');
        const current = counts[id]||0;
        const usedWithout = usedTotal(counts) - current;
        const remainingForThis = Math.max(0, drinksNeeded - usedWithout);
        counts[id] = remainingForThis;
        renderGrid();
      });
    });

    comboPrev.style.display='none';
    comboNext.textContent = confirmMode ? 'Add to Cart' : 'Next';
    comboNext.disabled = remaining>0;
  };

  const renderConfirm=()=>{
    comboTitle.textContent=item.name||'Confirm Selection';
    const fmt=id=>(findMenuItem(id)||{}).name||id;
    const drinkParts=Object.entries(counts).filter(([,c])=>c>0).map(([id,c])=>`${fmt(id)} x${c}`);
    const info=(findMenuItem(item.id)?.description)||'';
    comboSteps.innerHTML='1. Drinks ¬∑ <strong>2. Confirm</strong>';
    comboContent.innerHTML = `
      <div class="summary" style="gap:10px;">
        ${drinkParts.length?`<div><strong>Drinks:</strong> ${drinkParts.join(', ')}</div>`:''}
        ${info?`<div class="small muted">${info}</div>`:''}
      </div>`;
    comboPrev.style.display='none';
    comboNext.textContent='Add to Cart';
    comboNext.disabled=false;
  };

  comboPrev.onclick=()=>{};
  comboNext.onclick=()=>{
    if(!confirmMode){ confirmMode=true; renderConfirm(); return; }
    const espCount  = (counts['bev-esp']  || 0);
    const chocCount = (counts['bev-choc'] || 0);
    const upcharge = (20 * espCount) + (24 * chocCount);
    const fmt=id=>(findMenuItem(id)||{}).name||id;
    const drinkParts=Object.entries(counts).filter(([,c])=>c>0).map(([id,c])=>`${fmt(id)} x${c}`);
    const meta=drinkParts.length?`Drinks: ${drinkParts.join(', ')}`:'';
    addToCart({
      id:item.id,
      name:item.name + (upcharge>0?` (+$${upcharge} premium drinks)`:'' ),
      unitPrice:(item.price + upcharge),
      qty:qty||1,
      type:item.type,
      drinks:counts,
      meta
    });

    const waffles =
      item.id==='bd-med' ? 5 :
      (['bd-large','pk-beanbox','rf-beanbox'].includes(item.id) ? 10 : 0);
    if(waffles>0) addToCart({ id:'ex-waffle', name:'üßá Wonder Waffle (Included)', unitPrice:0, qty:waffles*(qty||1), type:'extra', meta:'Meal' });
    if(item.id==='pk-beanbox'){
      addToCart({ id:'ex-lunch', name:'üç± Lunch Box (Included)', unitPrice:0, qty:1*(qty||1), type:'extra', meta:'Bean Box' });
    }

    comboModal.close();
  };

  renderGrid();
  comboModal.showModal();
}

    // ---------- Ingredients (tab only) ----------
    function aggregateIngredients(){
      const tally={};
      const add=(n,x=1)=>{ if(!n) return; tally[n]=(tally[n]||0)+x; };

      state.cart.forEach(line=>{
        if(RECIPE_MAP[line.id]){
          for(const [ing,c] of Object.entries(RECIPE_MAP[line.id])) add(ing, c*line.qty);
        }
        if(line.drinks){
          for(const [drinkId,c] of Object.entries(line.drinks)){
            const rec = RECIPE_MAP[drinkId];
            if(rec) for(const [ing,n] of Object.entries(rec)) add(ing, n*c*(line.qty||1));
          }
        }
        if(line.id==='sp-hay' && line.cakes){
          for(const [cakeId,c] of Object.entries(line.cakes)){
            const rec = RECIPE_MAP[cakeId];
            if(rec) for(const [ing,n] of Object.entries(rec)) add(ing, n*c*(line.qty||1));
          }
        }
      });
      return tally;
    }
    function renderIngredients(){
      const wrap=document.getElementById('ingredientList');
      const entries=Object.entries(aggregateIngredients()).sort((a,b)=>a[0].localeCompare(b[0]));
      if(!entries.length){ wrap.innerHTML='<div class="muted">No ingredients yet. Add items to the cart.</div>'; return; }
      wrap.innerHTML = entries.map(([n,c])=>`<div class="ing-list"><div>${n}</div><div><strong>x${c}</strong></div></div>`).join('');
    }
    document.getElementById('copyIngBtn')?.addEventListener('click',()=>{
      const txt=Object.entries(aggregateIngredients()).sort((a,b)=>a[0].localeCompare(b[0])).map(([n,c])=>`- ${n} x${c}`).join('\n');
      navigator.clipboard.writeText(txt).then(()=>alert('Ingredients copied to clipboard!'));
    });
    document.getElementById('exportIngBtn')?.addEventListener('click',()=>{
      const rows=[['Ingredient','Count'],...Object.entries(aggregateIngredients()).sort((a,b)=>a[0].localeCompare(b[0]))];
      const csv=rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='beanmachine_ingredients.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    function renderAll(){ renderCards(); renderCart(); renderFulfillment(); renderTotals(); renderDiscount(); renderHistory(); }

    // ---------- Checkout / Reset ----------
    function checkout(){
      if(!state.cart.length){ alert('Your order is empty.'); return; }
      const subtotal=state.cart.reduce((s,l)=>s+l.unitPrice*l.qty,0);
      const manual=+(subtotal*(state.discountPct/100)).toFixed(2);
      const promo=computePromotions();
      const fee=state.fulfillment==='delivery'?(ZONE_FEES[state.deliveryZone]||0):0;
      const total=+(subtotal+fee-manual-promo.discount).toFixed(2);
      const entry={
        id:Date.now(),
        items:state.cart.map(l=>({ id:l.id||null,name:l.name,qty:l.qty,unit:l.unitPrice,meta:l.meta||null,drinks:l.drinks||null,cakes:l.cakes||null,type:l.type||'extra',lineTotal:+(l.unitPrice*l.qty).toFixed(2) })),
        discountPct:state.discountPct, subtotal:+subtotal.toFixed(2), deliveryFee:fee, promoDiscount:promo.discount, manualDiscount:manual, total
      };
      state.history.unshift(entry); persistHistory();
      state.cart=[]; state.discountPct=0; persist(); renderAll(); selectTab('summary');
    }
    function resetAll(){ state.cart=[]; state.discountPct=0; persist(); renderAll(); renderIngredients(); }

    document.getElementById('checkoutBtn').addEventListener('click',checkout);
    document.getElementById('checkoutBtn2').addEventListener('click',checkout);
    document.getElementById('resetBtn').addEventListener('click',resetAll);
    document.getElementById('resetBtn2').addEventListener('click',resetAll);

    // ---------- Theme ----------
    const themeBtn=document.getElementById('themeBtn');
    function applyTheme(t){ document.documentElement.setAttribute('data-theme',t); localStorage.setItem('beanmachine_theme',t); themeBtn.textContent=t==='dark'?'‚òÄÔ∏è Light':'üåô Dark'; themeBtn.setAttribute('aria-pressed',t==='dark'); }
    applyTheme(localStorage.getItem('beanmachine_theme')||'light');
    themeBtn.addEventListener('click',()=>{ const next=(localStorage.getItem('beanmachine_theme')||'light')==='light'?'dark':'light'; applyTheme(next); });

    // ---------- Loyalty (local) ----------
    const REQUIRED_PUNCHES=10;
    const loy={
      els:{
        id:document.getElementById('loy-player'), add:document.getElementById('loy-add'), undo:document.getElementById('loy-undo'),
        redeem:document.getElementById('loy-redeem'), tray:document.getElementById('loy-tray'), body:document.getElementById('loy-body'),
        stats:document.getElementById('loy-stats'), status:document.getElementById('loy-status'), dp:document.getElementById('dpStatus'),
        exportBtn:document.getElementById('loy-export'), importBtn:document.getElementById('loy-import'),
        visitInfo:document.getElementById('visitInfo'), newVisitBtn:document.getElementById('newVisitBtn'),
      },
      players: JSON.parse(localStorage.getItem('bm_loyalty_v1')||'{}'),
      currentId:null,
      visitId: Number(localStorage.getItem('bm_visit_id')||'1'),
      visitPunched: JSON.parse(localStorage.getItem('bm_visit_punched')||'[]'),
    };
    function savePlayers(){ localStorage.setItem('bm_loyalty_v1', JSON.stringify(loy.players)); }
    function saveVisit(){ localStorage.setItem('bm_visit_id', String(loy.visitId)); localStorage.setItem('bm_visit_punched', JSON.stringify(loy.visitPunched)); loy.els.visitInfo.textContent=`#${loy.visitId} ‚Ä¢ ${loy.visitPunched.length} punched`; }
    function newVisit(auto=false){ if(!auto && !confirm('Start a new visit?')) return; loy.visitId+=1; loy.visitPunched=[]; saveVisit(); loySetStatus(`Visit #${loy.visitId} started.`, true); }
    loy.els.newVisitBtn.addEventListener('click',()=>newVisit(false));
    function isDoubleTuesday(){ return new Date().getDay()===2; }
    function loySetStatus(msg, ok=true){ loy.els.status.innerHTML=`<span style="font-weight:700;${ok?'color:#1a7f37':'color:#b71c1c'}">${ok?'‚úì':'‚úó'}</span> ${msg}`; }
    function loyUpdateDPLabel(){ const a=isDoubleTuesday(); loy.els.dp.textContent=`Double Punch Tuesday: ${a?'ACTIVE all day':'auto all day on Tuesdays'}`; loy.els.dp.style.fontWeight=a?'700':'400'; }
    setInterval(loyUpdateDPLabel,30000); loyUpdateDPLabel(); saveVisit();

    function loyRenderTray(player){
      loy.els.tray.innerHTML=''; const punches=player?(player.punches||0):0;
      for(let i=0;i<REQUIRED_PUNCHES;i++){
        const div=document.createElement('div');
        div.className='chipbox'+(i<punches?' filled':'')+(i===REQUIRED_PUNCHES-1?' free':'');
        div.textContent = i<punches?'‚òï':(i===REQUIRED_PUNCHES-1?'FREE':'‚òï');
        loy.els.tray.appendChild(div);
      }
    }
    function loyRenderTable(){
      const entries=Object.entries(loy.players);
      loy.els.body.innerHTML = entries.map(([id,p])=>`
        <tr>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${id}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${p.punches||0}/${REQUIRED_PUNCHES}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${p.rewards||0}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${p.last? new Date(p.last).toLocaleString() : '‚Äî'}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)"><button class="btn" data-loyload="${id}">Load</button></td>
        </tr>`).join('');
      const totalRewards=entries.reduce((a,[,p])=>a+(p.rewards||0),0);
      loy.els.stats.textContent=`Players: ${entries.length} ‚Ä¢ Rewards banked: ${totalRewards}`;
      loy.els.body.querySelectorAll('[data-loyload]').forEach(b=>b.addEventListener('click',()=>{
        loy.currentId=b.getAttribute('data-loyload'); loy.els.id.value=loy.currentId; loyRenderTray(loy.players[loy.currentId]||null);
      }));
    }
    function loyaltyRenderAll(){ loyRenderTable(); loyRenderTray(loy.currentId?loy.players[loy.currentId]:null); }

    loy.els.add.addEventListener('click',()=>{
      const id=(loy.els.id.value||'').trim(); if(!id) return loySetStatus('Enter a customer name.',false);
      if(loy.visitPunched.includes(id)) return loySetStatus('Already punched this visit. Start a New Visit to punch again.', false);
      const inc=isDoubleTuesday()?2:1;
      const p=loy.players[id]||{punches:0,rewards:0,last:null};
      p.punches += inc;
      if(p.punches>=REQUIRED_PUNCHES){ p.punches -= REQUIRED_PUNCHES; p.rewards = (p.rewards||0)+1; }
      p.last = Date.now();
      loy.players[id]=p; savePlayers();
      loy.currentId=id; loy.visitPunched.push(id); saveVisit();
      loySetStatus(`Punch added (${p.punches}/${REQUIRED_PUNCHES})${inc===2?' (Double Tuesday!)':''}`, true);
      loyaltyRenderAll();
    });

    loy.els.undo.addEventListener('click',()=>{
      const id=(loy.els.id.value||'').trim(); if(!id) return loySetStatus('Enter a customer name.',false);
      const p=loy.players[id]; if(!p) return loySetStatus('Customer not found.',false);
      if(p.punches>0) p.punches--; else if(p.rewards>0){ p.rewards--; p.punches=REQUIRED_PUNCHES-1; }
      p.last=Date.now(); loy.players[id]=p; savePlayers();
      loy.visitPunched = loy.visitPunched.filter(x=>x!==id); saveVisit();
      loySetStatus('Removed one punch.', true); loyaltyRenderAll();
    });

    function openRewardWizardBM(){
      const item={ id:'loy-reward-bm', name:'üéÅ Loyalty Reward: Large Meal + 2 Cheesecakes', price:0, type:'bundle', drinksIncluded:10 };
      openComboWizard(item,1);
    }
    loy.els.redeem.addEventListener('click',()=>{
      const id=(loy.els.id.value||'').trim(); if(!id) return loySetStatus('Enter a customer name.',false);
      const p=loy.players[id]; if(!p || (p.rewards||0)<=0) return loySetStatus('No rewards banked for this customer.',false);
      p.rewards--; p.last=Date.now(); loy.players[id]=p; savePlayers();
      loy.currentId=id; loySetStatus('Reward redeemed! Pick your 10 drinks.', true);
      openRewardWizardBM();
    });

    const _oldAddToCart = addToCart;
    addToCart = function(line){
      _oldAddToCart(line);
      if(line && line.id==='loy-reward-bm'){
        _oldAddToCart({ id:'ex-waffle', name:'üßá Wonder Waffle (Loyalty Reward)', unitPrice:0, qty:10*(line.qty||1), type:'extra', meta:'Loyalty Reward' });
        _oldAddToCart({ id:'ex-cheese', name:'üç∞ Cheesecake (Loyalty Reward)', unitPrice:0, qty:2*(line.qty||1), type:'extra', meta:'Loyalty Reward' });
      }
    };

    loy.els.exportBtn.addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify({players:loy.players,visitId:loy.visitId},null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='beanmachine_loyalty_backup.json'; a.click();
    });
    loy.els.importBtn.addEventListener('click',()=>{
      const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange=e=>{
        const file=e.target.files[0]; if(!file) return;
        const fr=new FileReader(); fr.onload=()=>{ try{
          const data=JSON.parse(fr.result); if(data.players) loy.players=data.players;
          if(typeof data.visitId==='number') loy.visitId=data.visitId;
          localStorage.setItem('bm_loyalty_v1', JSON.stringify(loy.players)); saveVisit(); loyaltyRenderAll(); loySetStatus('Import complete.', true);
        }catch{ loySetStatus('Import failed (bad JSON).', false);} };
        fr.readAsText(file);
      };
      inp.click();
    });

    // ---------- Init ----------
    renderAll(); loyaltyRenderAll();
  </script>
</body>
</html>
